<?php-track-vars?>

<?php
  include("galery.php");

  $name = $HTTP_POST_VARS["name"];
  $email = $HTTP_POST_VARS["email"];

  if ($name != "" && $email != "" && $userfile != "")
  {
    if (!file_exists("galery/users.csv"))
    {
      $fh = fopen("galery/users.csv","w+");      
    } else $fh = fopen("galery/users.csv","r+");

    if ($fh)
    {
      $add_pic = 1;

      while ($data = fgetcsv($fh, 1000, ",")) 
      {
        if (!strcasecmp($data[0],$email))
        {
           echo("<center>Your photo is already inside SimpleMail's galery.</center><br>");
           galery_picture($data[2],$data[1],$data[0]);
           $add_pic = 0;
           break;
        }
      }

      if ($add_pic == 1)
      {
        do
        {
          $timeofday = gettimeofday();
          $pic_name = sprintf("%08lx%08lx.picture",$timeofday["sec"],$timeofday["usec"]);
        } while (file_exists("galery/" . $pic_name));
        copy($userfile,"galery/" . $pic_name);
        fputs($fh,sprintf("%s,%s,%s\n",$email,$name,$pic_name));
        echo("<center>Your photo has been succesfully added into SimpleMail's galery.</center><br>");
        galery_picture($pic_name, $name, $email);
      }

      fclose($fh);
    }
  } else
  {
    echo("No username or email address given<br>");
  }
?>


